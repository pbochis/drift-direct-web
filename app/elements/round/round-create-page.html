<link rel="import" href="../../styles/shared-styles.html">
<link rel="import" href="../shared/dd-ajax.html">
<link rel="import" href="../championship/create-tabs/rounds/round-create.html">

<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">

<dom-module id="round-create-page">
	<template>
		<style is="custom-style" include="shared-styles">
			:host{
				display: block;
				width: 70%;
				margin: 0 auto;
			}
			.controls {
				cursor: pointer;
				@apply(--layout-horizontal);
				@apply(--layout-center-center);
			}
		</style>

		<dd-ajax
			id="addRound"
			method="POST"
			on-response="_onResponse"
			body="{{round}}">
		</dd-ajax>

		<dd-ajax
			id="getEditModel"
			method="GET"
			last-response="{{round}}">
		</dd-ajax>

		<dd-ajax
			id="updateRound"
			method="PUT"
			on-response="_onResponse"
			body="{{round}}">
		</dd-ajax>

		<round-create id="roundForm" round="{{round}}"></round-create>

		<paper-material class="controls" on-click="_createRound">
			<iron-icon icon="add"></iron-icon>
			<span>Create round</span>
		</paper-material>
	</template>
	<script>
		Polymer({
			is: 'round-create-page',
			properties: {
				round: {
					type: Object,
					notify: true,
					value: {
						track: {},
						scheduele: []
					}
				},
				championshipId: {
					type: Number,
					notify: true
				},
				editMode: {
					type: Boolean,
					notify: true,
					value: false
				}
			},
			getRound: function(roundId){
				this.$.getEditModel.url = util.build('/round/' + roundId + '/edit');
				this.$.getEditModel.generateRequest();
				this.editMode = true;
			},
			_createRound: function(){
				if (!this.$.roundForm.validate()){
					return;
				}
				if (this.editMode){
					this.$.updateRound.url = util.build('/round/' + this.round.id);
					this.$.updateRound.generateRequest();
				}else{
					this.$.addRound.url = util.build('/championship/' + this.championshipId + '/rounds');
					this.$.addRound.generateRequest();
				}
			},
			_onResponse: function(){
				if (this.editMode){
					page('/round/' + this.round.id);
				}else{
					page('/championship/' + this.championshipId);
				}
				this.round = JSON.parse('{"track": {}, "scheduele": []}');
				this.editMode = false;
			}
		});
	</script>
</dom-module>