<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<script src="../bower_components/page/page.js"></script>
<script>
	window.addEventListener('WebComponentsReady', function () {

		// We use Page.js for routing. This is a Micro
		// client-side router inspired by the Express router
		// More info: https://visionmedia.github.io/page.js/

		// Removes end / from app.baseUrl which page.base requires for production
		if (window.location.port === '') {  // if production
			page.base(app.baseUrl.replace(/\/$/, ''));
		}

		// Middleware
		function scrollToTop(ctx, next) {
			app.scrollPageToTop();
			next();
		}

		function closeDrawer(ctx, next) {
			app.closeDrawer();
			next();
		}

		function checkIsLoggedIn(){
			if (!util.loggedIn()){
				page('/login');
				return false;
			}
			return true;
		}

		// Routes
		page('*', scrollToTop, closeDrawer, function (ctx, next) {
			next();
		});

		page('/', function () {
			if (!util.loggedIn()){
				page('/login');
			}
			else{
				page('/championships');
			}
		});

		page('/login', function(){
			localStorage.user = null;
			app.hideMenu();
			app.route = 'login';
			app.isLoggedIn = false;
		});

		page('/championships', function(){
			if (!checkIsLoggedIn()){
				return;
			}
			app.header = 'Championships';
			app.route = 'championships';
			app.$.championships.getChampionships();
		});

		page('/championship/:championshipId', function(data){
			if (!checkIsLoggedIn()){
				return;
			}
			app.route = 'championship-view';
			var id = data.params.championshipId;
			app.$.championship.getChampionship(id);
		});


		page('/championships/create', function(){
			if (!checkIsLoggedIn()){
				return;
			}
			app.route = 'championship-create';
			app.header = 'New championship';
			app.$.championshipCreate.getPersons();
		});

		page('/news/:championshipId', function(data){
			if (!checkIsLoggedIn()){
				return;
			}
			var championshipId = data.params.championshipId;
			app.route = 'news-create';
			app.header = 'News';
			app.$.newsCreate.championship = championshipId;
		});

		page('/round/:id/tab/:tab', function(data){
			if (!checkIsLoggedIn()){
				return;
			}
			console.log('round is good');
			app.route = 'round-view';
			var id = data.params.id;
			var tab = data.params.tab;
			localStorage.selectedRound = id;
			app.$.round.getRound(id);
			app.$.round.selectedTab = tab;
		});

		page('/round/:id', function(data){
			if (!checkIsLoggedIn()){
				return;
			}
			app.route = 'round-view';
			var id = data.params.id;
			localStorage.selectedRound = id;
			app.$.round.getRound(id);
		});

		page('/register/:roundId', function(data){
			if (!checkIsLoggedIn()){
				return;
			}
			app.route = 'register-driver';
			var id = data.params.roundId;
			app.$.register.getData(id);
		});

		page('/qualifiers/:qualifierId', function(data){
			if (!checkIsLoggedIn()){
				return;
			}
			app.route = 'qualifier-judging';
			var id = data.params.qualifierId;
			app.$.qualifierJudging.getQualifierJudge(id);
		});

		page('/playoff/battle/judge/:battleId', function(data){
			if (!checkIsLoggedIn()){
				return;
			}
			app.route = 'playoff-judging';
			var id = data.params.battleId;
				app.$.playoffJudging.startJudging(id);
		});

		page('/persons', function(){
			if (!checkIsLoggedIn()){
				return;
			}
			console.log('wtf');
			app.route = 'persons';
			app.header = 'Persons';
				app.$.persons.getPersons();
		});

		page('/person/:personId', function(data){
			if (!checkIsLoggedIn()){
				return;
			}
			app.route = 'person-view';
			app.header = 'Person';
			var id = data.params.personId;
				app.$.person.getPerson(id);
		});


		page('/sponsors', function(){
			if (!checkIsLoggedIn()){
				return;
			}
			app.route = 'sponsors';
			app.header = 'Sponsors';
				app.$.sponsors.getSponsors();
		});

		page('/sponsor/new', function(){
			if (!checkIsLoggedIn()){
				return;
			}
			app.route = 'sponsor-create';
			app.header = 'New Sponsor';
		});

		page('/users', function () {
			if (!checkIsLoggedIn()){
				return;
			}
			app.route = 'users';
			app.header = 'Users';
				app.$.users.getUsers();
		});

		page ('/user/create', function(){
			if (!checkIsLoggedIn()){
				return;
			}
			app.route = 'user-create';
			app.header = 'Create user';
				app.$.userCreate.getRoles();
		});

		page('/users/:name', function (data) {
			app.route = 'user-info';
			app.params = data.params;
		});

		page('/contact', function () {
			app.route = 'contact';
		});

		// 404
		page('*', function () {
			app.$.toast.text = 'Can\'t find: ' + window.location.href + '. Redirected you to Home Page';
			app.$.toast.show();
			page.redirect(app.baseUrl);
		});

		// add #! before urls
		page({
			hashbang: true
		});

	});
</script>
